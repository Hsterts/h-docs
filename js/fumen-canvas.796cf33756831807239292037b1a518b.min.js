const{decoder,encoder}=require("tetris-fumen");allGridToggle=!1;var colors={I:{normal:"#41afde",highlight1:"#3dc0fb",highlight2:"#3dc0fb",lighter:"#3dc0fb",light:"#43d3ff"},T:{normal:"#b451ac",highlight1:"#d161c9",highlight2:"#d161c9",lighter:"#d161c9",light:"#e56add"},S:{normal:"#66c65c",highlight1:"#75d96a",highlight2:"#7cd97a",lighter:"#7cd97a",light:"#88ee86"},Z:{normal:"#ef624d",highlight1:"#ff7866",highlight2:"#ff8778",lighter:"#fd7660",light:"#ff9484"},L:{normal:"#ef9535",highlight1:"#ffa94d",highlight2:"#ffae58",lighter:"#fea440",light:"#ffbf60"},J:{normal:"#1983bf",highlight1:"#1997e3",highlight2:"#1997e3",lighter:"#1997e3",light:"#1ba6f9"},O:{normal:"#f7d33e",highlight1:"#ffe34b",highlight2:"#ffe34b",lighter:"#ffe34b",light:"#fff952"},X:{normal:"#bbbbbb",highlight1:"#686868",highlight2:"#686868",lighter:"#bbbbbb",light:"#cccccc"},Empty:{normal:"#f3f3ed"}};function draw(f,{numrows:u,numcols:d,cellSize:e,gridToggle:c,gridColor:o,transparency_four:g,background:p,delay:y,lock:b,outline:h}){var e=parseFloat(e),m,v,a,s=f.field,r=e*d,n=u*e,l=document.createElement("canvas");l.width=r,l.height=n;const t=l.getContext("2d");g?t.fillStyle="#00000000":t.fillStyle=p,t.fillRect(0,0,r,n),allGridToggle&&(o="#ffffff"),(c||allGridToggle)&&(t.strokeStyle=o,t.strokeRect(0,0,r,n));for(i=0;i<d;i++)for(j=0;j<u;j++)s.at(i,j)!="_"&&(t.fillStyle=colors[s.at(i,j)].normal,t.fillRect(i*e,n-(j+1)*e,e,e),(c||allGridToggle)&&(t.fillStyle=o+"40",t.fillRect(i*e,n-(j+1)*e,1,e),t.fillRect(i*e,n-(j+1)*e,e,1),t.fillRect((i+1)*e,n-(j+1)*e,1,e),t.fillRect(i*e,n-j*e,e,1)),s.at(i,j+1)=="_"&&(t.fillStyle=colors[s.at(i,j)].light,t.fillRect(i*e,n-(j+1)*e-e/5,e,e/5),(c||allGridToggle)&&(t.fillStyle=o+"CC",t.fillRect(i*e,n-(j+1)*e-e/5,e,1),s.at(Math.max(0,i-1),j+1)=="_"?(t.fillStyle=o+"CC",t.fillRect(i*e,n-(j+1)*e-e/5,1,e/5)):(t.fillStyle=o+"FF",t.fillRect(i*e,n-(j+1)*e-e/5,1,e/5)),s.at(i+1,j+1)=="_"&&(t.fillStyle=o+"CC",t.fillRect((i+1)*e,n-(j+1)*e-e/5,1,e/5)))),(c||allGridToggle)&&(t.fillStyle=o+"FF",s.at(Math.max(i-1,0),j)=="_"&&t.fillRect(i*e,n-(j+1)*e,1,e+1),s.at(i,j+1)=="_"&&t.fillRect(i*e,n-(j+1)*e,e+1,1),s.at(i+1,j)=="_"&&t.fillRect((i+1)*e,n-(j+1)*e,1,e+1),s.at(i,j-1)=="_"&&t.fillRect(i*e,n-j*e,e+1,1)));if(b)for(i=0;i<d;i++){m=0;for(j=0;j<u;j++)s.at(j,i)!="_"&&m++;m==10&&(t.fillStyle="#FFFFFF40",t.fillRect(0,n-(i+1)*e,r,e))}if(h){v=f.index,a=decoder.decode(h)[v].field;for(i=0;i<d;i++)for(j=0;j<u;j++)a.at(i,j)!="_"&&(t.fillStyle="#FFFFFF",a.at(Math.max(i-1,0),j)=="_"&&t.fillRect(i*e-1,n-(j+1)*e,2,e+1),a.at(i,j+1)=="_"&&t.fillRect(i*e-1,n-(j+1)*e,e+1,2),a.at(i+1,j)=="_"&&t.fillRect((i+1)*e-1,n-(j+1)*e,2,e+1),a.at(i,j-1)=="_"&&t.fillRect(i*e-1,n-j*e,e+1,2))}return l}function drawFumens(r,{numrows:s,numcols:o,cellSize:t,gridToggle:f,gridColor:m,transparency_four:a,background:c,delay:n,lock:l,outline:d}){var u=t*o,e,p,h=s*t,i=document.createElement("canvas");i.width=u,i.height=h,e=new GIFEncoder,e.start(),e.setRepeat(0),e.setDelay(n),e.setQuality(1),a&&e.setTransparent("rgba(0, 0, 0, 0)");for(x=0;x<r.length;x++)p=draw(r[x],{numrows:s,numcols:o,cellSize:t,gridToggle:f,gridColor:m,transparency_four:a,background:c,delay:n,lock:l,outline:d}).getContext("2d"),e.addFrame(p);return e.finish(),e}function generateDiagram(a,o){var n=decoder.decode(a),r,c,l,s,e,i,t=document.createElement("img");if(n.length==1&&(r=draw(n[0],o),t.src=r.toDataURL("image/png"),t.className="fumen-image"),n.length>1&&(gif=drawFumens(n,o),c=gif.stream().getData(),l="data:image/gif;base64,"+btoa(c),t=document.createElement("img"),t.src=l,t.className="fumen-image"),s=document.createElement("figure"),s.className=o.figure?"fumen-figure":"fumen-figure minimized",e=document.createElement("button"),e.className="fumen-clipboard-button",e.type="button",e.innerHTML=svgCopy,e.addEventListener("click",()=>{navigator.clipboard.writeText(a).then(()=>{e.blur(),e.innerHTML=svgCheck,setTimeout(()=>{e.innerHTML=svgCopy,e.style.borderColor=""},2e3)},t=>e.innerHTML="Error")}),s.appendChild(e),s.appendChild(t),n[0].comment&&o.figure){i=document.createElement("figcaption"),captionLines=n[0].comment.split("\n");for(let e=0;e<captionLines.length;e++){if(span=document.createElement("span"),words=captionLines[e],mirrored){words=captionLines[e].split(" ");for(let e=0;e<words.length;e++)words[e].match(/^[TILJSZO]+$/g)&&(words[e]=words[e].replace("L","X").replace("S","Y").replace("J","L").replace("Z","S").replace("X","J").replace("Y","Z"));words=words.join(" ")}span.innerText=words,i.appendChild(span),i.appendChild(document.createElement("br"))}s.appendChild(i)}return s}function fumencanvas(e,n){e.dataset.code==null&&(e.dataset.code=e.innerHTML);var t=e.dataset.code,s;e.innerText='',s={figure:n,numrows:parseFloat(e.getAttribute("height"))||5,numcols:parseFloat(e.getAttribute("width"))||10,cellSize:parseFloat(e.getAttribute("size"))||22,gridColor:parseFloat(e.getAttribute("grid")),gridToggle:e.getAttribute("grid")!=null,background:parseFloat(e.getAttribute("background")),transparency_four:e.getAttribute("background")==null,delay:parseFloat(e.getAttribute("delay"))||500,lock:e.getAttribute("lock"),outline:e.getAttribute("outline")},mirrored&&(t=mirrorFumen(t)[0],outlineCodes=mirrorFumen(outlineCodes)[0]);try{e.appendChild(generateDiagram(t,s))}catch(e){console.log(t,e)}}function minocanvas(e){e.getAttribute("mino")==null&&e.setAttribute("mino",e.innerText);var t=e.getAttribute("mino"),n;if(e.innerText='',mirrored){let e='';for(let n of t)if("LJSZ".includes(n))switch(n){case"L":e+="J";break;case"J":e+="L";break;case"S":e+="Z";break;case"Z":e+="S";break}else e+=n;t=e}for(let s=0;s<t.length;s++)"TILJSZO".indexOf(t[s])!=-1&&(n=document.createElement("img"),n.setAttribute("draggable",!1),n.src="/h-docs/attachments_mino/"+t[s]+".png",e.appendChild(n))}function formatPage(){Array.from(document.getElementsByTagName("fumen")).forEach(e=>fumencanvas(e,!1)),Array.from(document.getElementsByTagName("figfumen")).forEach(e=>fumencanvas(e,!0)),Array.from(document.getElementsByClassName("mino")).forEach(e=>minocanvas(e))}window.addEventListener("million:navigate",formatPage),window.addEventListener("DOMContentLoaded",formatPage)