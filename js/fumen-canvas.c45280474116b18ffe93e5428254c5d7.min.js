const{decoder,encoder}=require("tetris-fumen");var colors={I:{normal:"#41afde",highlight1:"#3dc0fb",highlight2:"#3dc0fb",lighter:"#3dc0fb",light:"#43d3ff"},T:{normal:"#b451ac",highlight1:"#d161c9",highlight2:"#d161c9",lighter:"#d161c9",light:"#e56add"},S:{normal:"#66c65c",highlight1:"#75d96a",highlight2:"#7cd97a",lighter:"#7cd97a",light:"#88ee86"},Z:{normal:"#ef624d",highlight1:"#ff7866",highlight2:"#ff8778",lighter:"#fd7660",light:"#ff9484"},L:{normal:"#ef9535",highlight1:"#ffa94d",highlight2:"#ffae58",lighter:"#fea440",light:"#ffbf60"},J:{normal:"#1983bf",highlight1:"#1997e3",highlight2:"#1997e3",lighter:"#1997e3",light:"#1ba6f9"},O:{normal:"#f7d33e",highlight1:"#ffe34b",highlight2:"#ffe34b",lighter:"#ffe34b",light:"#fff952"},X:{normal:"#bbbbbb",highlight1:"#686868",highlight2:"#686868",lighter:"#bbbbbb",light:"#cccccc"},Empty:{normal:"#f3f3ed"}};function draw(u,{numrows:o,numcols:l,cellSize:e,gridToggle:r,gridColor:a,transparency_four:f,background:p}){var s=u.field,d,n,c,h=u.operation;function m(e){return i==e.x&&j==e.y}if(o==void 0){o=0;for(i=0;i<l;i++)for(j=0;j<23;j++)s.at(i,j)!="_"&&(o=Math.max(o,j)),h!=void 0&&h.positions().filter(m).length>0&&(o=Math.max(o,j));o+=2}d=e*l,n=o*e,c=document.createElement("canvas"),c.width=d,c.height=n;const t=c.getContext("2d");if(f?t.fillStyle="#00000000":t.fillStyle=p,t.fillRect(0,0,d,n),r){t.strokeStyle=a,t.strokeRect(0,0,d,n);for(i=0;i<l;i++)for(j=0;j<o;j++)t.fillStyle=a+"30",t.fillRect(i*e,n-(j+1)*e,1,e),t.fillRect(i*e,n-(j+1)*e,e,1)}for(i=0;i<l;i++)for(j=0;j<o;j++)s.at(i,j)!="_"&&(t.fillStyle=colors[s.at(i,j)].normal,t.fillRect(i*e,n-(j+1)*e,e,e),r&&(t.fillStyle=a+"40",t.fillRect(i*e,n-(j+1)*e,1,e),t.fillRect(i*e,n-(j+1)*e,e,1),t.fillRect((i+1)*e,n-(j+1)*e,1,e),t.fillRect(i*e,n-j*e,e,1)),s.at(i,j+1)=="_"&&(t.fillStyle=colors[s.at(i,j)].light,t.fillRect(i*e,n-(j+1)*e-e/5,e,e/5),r&&(t.fillStyle=a+"CC",t.fillRect(i*e,n-(j+1)*e-e/5,e,1),s.at(Math.max(0,i-1),j+1)=="_"?(t.fillStyle=a+"CC",t.fillRect(i*e,n-(j+1)*e-e/5,1,e/5)):(t.fillStyle=a+"FF",t.fillRect(i*e,n-(j+1)*e-e/5,1,e/5)),s.at(i+1,j+1)=="_"&&(t.fillStyle=a+"CC",t.fillRect((i+1)*e,n-(j+1)*e-e/5,1,e/5)))),r&&(t.fillStyle=a+"FF",s.at(Math.max(i-1,0),j)=="_"&&t.fillRect(i*e,n-(j+1)*e,1,e+1),s.at(i,j+1)=="_"&&t.fillRect(i*e,n-(j+1)*e,e+1,1),s.at(i+1,j)=="_"&&t.fillRect((i+1)*e,n-(j+1)*e,1,e+1),s.at(i,j-1)=="_"&&t.fillRect(i*e,n-j*e,e+1,1)));return c}function generateDiagram(o,r,i){var a=draw(o,r),s,e,n,t=document.createElement("figure");if(t.className="fumen-figure",s=document.createElement("img"),s.src=a.toDataURL("image/png"),s.className="imageOutput",e=document.createElement("button"),e.className="fumen-clipboard-button",e.type="button",e.innerHTML=svgCopy,e.addEventListener("click",()=>{navigator.clipboard.writeText(i).then(()=>{e.blur(),e.innerHTML=svgCheck,setTimeout(()=>{e.innerHTML=svgCopy,e.style.borderColor=""},2e3)},t=>e.innerHTML="Error")}),t.appendChild(e),t.appendChild(s),o.comment){n=document.createElement("figcaption"),captionLines=o.comment.split("\n");for(let e=0;e<captionLines.length;e++){if(span=document.createElement("span"),words=captionLines[e],mirrored){words=captionLines[e].split(" ");for(let e=0;e<words.length;e++)words[e].match(/^[TILJSZO]+$/g)&&(words[e]=words[e].replace("L","X").replace("S","Y").replace("J","L").replace("Z","S").replace("X","J").replace("Y","Z"));words=words.join(" ")}span.innerText=words,n.appendChild(span),n.appendChild(document.createElement("br"))}t.appendChild(n)}return t}function fumencanvas(e,i){e.dataset.code==null&&(e.dataset.code=e.innerHTML);var a=e.dataset.code,s,t,n,o;if(e.innerText='',s={numrows:e.getAttribute("height")||5,numcols:e.getAttribute("width")||10,cellSize:e.getAttribute("size")||22,gridColor:e.getAttribute("grid"),gridToggle:e.getAttribute("grid")!=null,background:e.getAttribute("background"),transparency_four:e.getAttribute("background")==null},t=a.split(/\s+/),mirrored)for(let e=0;e<t.length;e++)t[e]=mirrorFumen(t[e])[0];for(let a of t)try{i?e.appendChild(generateDiagram(decoder.decode(a)[0],s,a)):(n=document.createElement("details"),o=document.createElement("summary"),o.textContent=e.getAttribute("spoiler")||"Solves",n.appendChild(o),decoder.decode(a).forEach(e=>n.appendChild(generateDiagram(e,s,a))),e.appendChild(n))}catch(e){console.log(a,e)}}function minocanvas(e){e.getAttribute("mino")==null&&e.setAttribute("mino",e.innerText);var t=e.getAttribute("mino"),n;if(e.innerText='',mirrored){let e='';for(let n of t)if("LJSZ".includes(n))switch(n){case"L":e+="J";break;case"J":e+="L";break;case"S":e+="Z";break;case"Z":e+="S";break}else e+=n;t=e}for(let s=0;s<t.length;s++)"TILJSZO".indexOf(t[s])!=-1&&(n=document.createElement("img"),n.src="/h-docs/attachments_mino/"+t[s]+".png",e.appendChild(n))}function formatPage(){Array.from(document.getElementsByTagName("fumen")).forEach(e=>fumencanvas(e,!0)),Array.from(document.getElementsByTagName("solution")).forEach(e=>fumencanvas(e,!1)),Array.from(document.getElementsByClassName("mino")).forEach(e=>minocanvas(e))}window.addEventListener("million:navigate",formatPage),window.addEventListener("DOMContentLoaded",formatPage)